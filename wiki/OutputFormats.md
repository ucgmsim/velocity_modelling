# Output Formats in NZCVM

This page provides detailed information about the output formats generated by the NZCVM, including the EMOD3D format and CSV files.

## EMOD3D Format

The EMOD3D format is the primary output format of the NZCVM. It is used by the EMOD3D finite difference wave propagation code for earthquake ground motion simulations.

### File Structure

The EMOD3D output consists of three binary files:
- `<model_name>.v_p`: P-wave velocity values
- `<model_name>.v_s`: S-wave velocity values
- `<model_name>.rho`: Density values

Each file contains a 3D grid of values in a binary format, with values arranged in column-major order (Fortran order).

### Header Information

The header information for the model is stored in a separate text file named `<model_name>.info`. This file contains:

```
hh: Grid spacing (in kilometers)
nx, ny, nz: Number of grid points in x, y, and z directions
modellon, modellat: Longitude and latitude of the model origin
modelrot: Rotation angle of the model grid (in degrees)
topo_type: Type of topography used (BULLDOZED, SQUASHED, etc.)
```

### Reading EMOD3D Files

Here's an example of how to read EMOD3D files in Python:

```python
import numpy as np

def read_emod3d_file(filename, nx, ny, nz):
    """
    Read an EMOD3D binary file.
    
    Parameters:
    filename (str): Path to the EMOD3D file
    nx, ny, nz (int): Grid dimensions
    
    Returns:
    numpy.ndarray: 3D array of values
    """
    with open(filename, 'rb') as f:
        data = np.fromfile(f, dtype=np.float32)
    
    # Reshape to 3D grid (Fortran order)
    data = data.reshape((nx, ny, nz), order='F')
    
    return data

# Read header information
with open('model.info', 'r') as f:
    lines = f.readlines()
    hh = float(lines[0].strip())
    nx, ny, nz = map(int, lines[1].strip().split())
    modellon, modellat = map(float, lines[2].strip().split())
    modelrot = float(lines[3].strip())
    topo_type = lines[4].strip()

# Read velocity and density files
vp = read_emod3d_file('model.v_p', nx, ny, nz)
vs = read_emod3d_file('model.v_s', nx, ny, nz)
rho = read_emod3d_file('model.rho', nx, ny, nz)
```

## CSV Format

In addition to the EMOD3D format, the NZCVM can also output velocity models in CSV format for easier inspection and analysis.

### Format Specification

The CSV output contains one row per grid point, with the following columns:
- `x`, `y`, `z`: Grid coordinates (in kilometers)
- `lon`, `lat`, `depth`: Geographic coordinates
- `vp`: P-wave velocity (in meters per second)
- `vs`: S-wave velocity (in meters per second)
- `rho`: Density (in kilograms per cubic meter)

### Example

```
x,y,z,lon,lat,depth,vp,vs,rho
0.0,0.0,0.0,172.5000,-43.5000,0.0,1500.0,500.0,2000.0
0.2,0.0,0.0,172.5020,-43.5000,0.0,1520.0,510.0,2010.0
0.4,0.0,0.0,172.5040,-43.5000,0.0,1540.0,520.0,2020.0
...
```

### Reading CSV Files

CSV files can be easily read using standard libraries in most programming languages. Here's an example in Python:

```python
import pandas as pd

# Read CSV file
df = pd.read_csv('model.csv')

# Get velocity values at a specific location
x, y, z = 1.0, 2.0, 0.5
point = df[(df['x'] == x) & (df['y'] == y) & (df['z'] == z)]
vp = point['vp'].values[0]
vs = point['vs'].values[0]
rho = point['rho'].values[0]
```

## Other Output Files

Depending on the configuration, the NZCVM may also generate additional output files:

- **Log files**: Contains information about the model generation process, including any warnings or errors.
- **Visualization files**: For visualization in tools like PyVista or ParaView.
- **Metadata files**: JSON or YAML files containing metadata about the generated model.

## Output Location

By default, output files are stored in the directory specified by the `--out-dir` argument when running the `nzvm.py` script. If not specified, they are stored in the directory specified by the `OUTPUT_DIR` parameter in the configuration file.

Each model version and configuration creates a separate subdirectory to avoid overwriting existing files.
